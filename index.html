<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="referrer" content="no-referrer" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
</head>

<body>
    <div id="app">
        {{ config }}
        <br> {{ message }}
        <table class="table-striped table-sm">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Queen</th>
                    <th>Votes</th>
                    <th>PCT</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="queen in listItems">
                    <td>{{ queen.id }}</td>
                    <td>{{ queen.text }}</td>
                    <td>{{ queen.count.total.toLocaleString() }}</td>
                    <td>{{ queen.count.pct }}%</td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/marked@0.3.6"></script>
    <script src="https://unpkg.com/lodash@4.16.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
        var meta = document.createElement('meta');
        meta.name = "referrer";
        meta.content = "no-referrer";
        document.getElementsByTagName('head')[0].appendChild(meta);
        var VOTING_URL = 'https://api.massrelevance.com/v1/polls.json?poll=4SE&option=S50';
        //var RESULTS_URL='https://api.massrelevance.com/v1/polls.json?poll=4SE';
        var query = window.location.search.substring(1) || 'count=1000&sec=200&opo=2';
        var count = parseInt(query.split('&')[0].split('=')[1]);
        var sec = parseInt(query.split('&')[1].split('=')[1]);
        var opo = parseInt(query.split('&')[2].split('=')[1]);
        var dataURL = 'https://api.massrelevance.com/v1/polls.json?poll=4SE';
        /*var posts = $.getJSON(dataURL, function (data) {
            return data;
        });*/
        var app = new Vue({
            el: '#app',
            data: {
                message: 'Hello Vue!',
                config: '',
                queens: [] // initialize empty array
            },
            mounted() { // when the Vue app is booted up, this is run automatically.
                var self = this // create a closure to access component in the callback below
                $.getJSON(dataURL, function (data) {
                    self.queens = data.data.polls[0].options;
                    self.config = 'Count: ' + count + ' Sec: ' + sec + ' DIF: ' + (self.queens[8].count
                        .total - self.queens[opo].count.total);
                });
            },
            computed: {
                listItems() {
                    return _.orderBy(this.queens, 'count.total', 'desc');
                }
            },
            methods: {

            }
        });

        function loadData() {
            $.getJSON(dataURL, function (data) {
                app.queens = data.data.polls[0].options;
            });
        }

        var myTimer = setInterval(function () {
            console.log('refresh');
            app.message = app.message + ' => refresh';
            app.config = 'Count: ' + count + ' Sec: ' + sec + ' DIF: ' + (app.queens[8].count.total - app.queens[opo].count.total);
            loadData(); // this will run after every 5 seconds
        }, 10000);

        var c = count;

        var myPost = setInterval(function () {
            $.post(VOTING_URL, function (data) {
                app.message = 'Vote N° ' + c + ' => ' + data.status;
            });
            --c;
            if (c === 0) { // If i > 0, keep going
                clearInterval(myPost);
                clearInterval(myTimer);
            }
        }, sec);

        /* (function theLoop(i) {
            setTimeout(function () {
                $.post(VOTING_URL, function (data) {
                    console.log(data.status);
                    app.message = 'Vote N° ' + i + ' => ' + data.status;
                });
                if (--i) { // If i > 0, keep going
                    theLoop(i); // Call the loop again, and pass it the current value of i                    
                } else {
                    clearInterval(myTimer);
                }
            }, sec);
        })(count); */
    </script>
</body>

</html>